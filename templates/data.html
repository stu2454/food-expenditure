{% extends "base.html" %}

{% block title %}Data - Household Spending Estimates{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="bi bi-table text-primary"></i>
                Full Dataset
            </h1>
            <p class="lead text-muted">
                Complete monthly data with calculations
            </p>
        </div>
    </div>

    <!-- Summary Info -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-info-circle text-primary"></i> Dataset Information</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Total Observations:</strong> {{ total_rows }} months</li>
                        <li><strong>Date Range:</strong> {{ table_data[0].month if table_data else 'N/A' }} to {{ table_data[-1].month if table_data else 'N/A' }}</li>
                        <li><strong>Series:</strong> Seasonally Adjusted</li>
                        <li><strong>Units:</strong> AUD$ per household per month</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-download text-success"></i> Export Options</h6>
                    <p class="mb-2">Download this data for further analysis:</p>
                    <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard()">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">Monthly Data</h5>
                        </div>
                        <div class="col-auto">
                            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search...">
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="dataTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Month</th>
                                    <th class="text-end">National Spending<br><small class="text-muted">(AUD$ millions)</small></th>
                                    <th class="text-end">Households<br><small class="text-muted">(count)</small></th>
                                    <th class="text-end">Per-Household<br><small class="text-muted">(AUD$/month)</small></th>
                                    <th class="text-end">12-Month Avg<br><small class="text-muted">(AUD$/month)</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table_data %}
                                <tr>
                                    <td><strong>{{ row.month }}</strong></td>
                                    <td class="text-end">${{ "%.1f"|format(row.food_aud_m_sa) }}</td>
                                    <td class="text-end">{{ "{:,}".format(row.households|int) }}</td>
                                    <td class="text-end"><strong>${{ "%.2f"|format(row.food_per_household_month) }}</strong></td>
                                    <td class="text-end text-muted">${{ "%.2f"|format(row.food_per_hh_12m_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Showing all {{ total_rows }} months of available data. 
                        Use search box to filter rows.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Explanations -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-question-circle text-info"></i> Column Definitions</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Month</dt>
                        <dd class="col-sm-9">Reference month in YYYY-MM format</dd>
                        
                        <dt class="col-sm-3">National Spending</dt>
                        <dd class="col-sm-9">Total Australian household food spending from ABS MHSI, in millions of dollars (seasonally adjusted)</dd>
                        
                        <dt class="col-sm-3">Households</dt>
                        <dd class="col-sm-9">Total Australian household count from ABS projections (annual step function)</dd>
                        
                        <dt class="col-sm-3">Per-Household</dt>
                        <dd class="col-sm-9">Average monthly grocery spending per household (National Spending รท Households)</dd>
                        
                        <dt class="col-sm-3 mb-0">12-Month Avg</dt>
                        <dd class="col-sm-9 mb-0">Rolling 12-month average of per-household spending (smoothed trend indicator)</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.getElementById('dataTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
});

// Export to CSV
function exportToCSV() {
    const table = document.getElementById('dataTable');
    let csv = [];
    
    // Header
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.replace(/\s+/g, ' ').trim());
    });
    csv.push(headers.join(','));
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(tr => {
        if (tr.style.display !== 'none') {
            const row = [];
            tr.querySelectorAll('td').forEach(td => {
                let text = td.textContent.trim().replace(/[$,]/g, '');
                row.push(text);
            });
            csv.push(row.join(','));
        }
    });
    
    // Download
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'household_spending_data_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Copy to clipboard
function copyToClipboard() {
    const table = document.getElementById('dataTable');
    let text = '';
    
    // Header
    table.querySelectorAll('thead th').forEach(th => {
        text += th.textContent.replace(/\s+/g, ' ').trim() + '\t';
    });
    text += '\n';
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(tr => {
        if (tr.style.display !== 'none') {
            tr.querySelectorAll('td').forEach(td => {
                text += td.textContent.trim() + '\t';
            });
            text += '\n';
        }
    });
    
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}
</script>
{% endblock %}
